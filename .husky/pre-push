#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" = "main" ]; then
  commit_msg=$(git log -1 --pretty=%s)
  if echo "$commit_msg" | grep -Eq '^v [0-9]+\.[0-9]+\.[0-9]+$'; then
    exit 0
  fi
  node -e "const fs=require('fs');const paths=['package.json','packages/iframe-rpc-client/package.json','packages/iframe-rpc-server/package.json'];let root=JSON.parse(fs.readFileSync(paths[0],'utf8'));let vers=String(root.version||'0.0.6');let parts=vers.split('.').map(v=>parseInt(v,10));if(parts.some(Number.isNaN)){parts=[0,0,6]}const v=[parts[0],parts[1],parts[2]+1].join('.');for(const p of paths){const j=JSON.parse(fs.readFileSync(p,'utf8'));j.version=v;fs.writeFileSync(p,JSON.stringify(j,null,2)+'\n');}fs.writeFileSync('version.txt',v)"
  v=$(cat version.txt)
  git add package.json packages/iframe-rpc-client/package.json packages/iframe-rpc-server/package.json
  git commit -m "v $v" || true
  rm -f version.txt
  echo "version bumped to v $v; please push again"
  exit 1
fi
